<!--
Version: 10.0.0 (Supabase Migration)
Date: July 31, 2025
Notes:
- This version is designed to run on Supabase.
- All sensitive data (API Key, System Prompt) has been removed from the client-side code.
- The chatbot now communicates with a secure Supabase Edge Function ("coaching-proxy") instead of directly with the Gemini API.
- Added the Supabase JS client library.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartlinks Coaching Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #003F5C;
            animation: spin 1s ease infinite;
        }
        .chat-spinner .spinner {
             border: 4px solid rgba(255, 255, 255, 0.3);
             border-left-color: #ffffff;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chat-button {
            background-color: #005f88;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 4px;
        }
        .chat-button:hover {
            background-color: #007ab8;
        }
        .voice-button {
            background-color: #4A5568; /* gray-700 */
            padding: 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s;
        }
        .voice-button:hover {
            background-color: #2D3748; /* gray-800 */
        }
        .voice-button.listening {
            background-color: #c53030; /* red-600 */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#003F5C] mb-4">Smartlinks Coaching Platform</h1>
            <p class="text-lg text-[#374C80]">Your AI-Powered Coaching Companion</p>
            <p class="text-md text-[#374C80] mt-4">Created by: Heera Ganjikota - ICF PCC</p>
        </header>

        <main>
            <section id="gemini-tool" class="mb-16">
                <div class="bg-gradient-to-br from-[#003F5C] to-[#374C80] rounded-lg shadow-xl p-6 md:p-8 text-white">
                    <h3 class="text-3xl font-bold text-center mb-4">Your Coaching Companion</h3>
                    <p id="companion-description" class="text-center max-w-2xl mx-auto mb-6 opacity-90">Start a conversation about a goal or challenge you're facing. This AI companion is here to help you explore your thinking, gain clarity, and discover new paths forward.</p>
                    <div class="max-w-2xl mx-auto bg-white/10 rounded-lg p-4">
                        <div id="chat-window" class="h-80 overflow-y-auto pr-2 space-y-4 flex flex-col">
                            <!-- Chat messages will be appended here -->
                        </div>
                        <div id="chat-input-container" class="mt-4 flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                            <input type="text" id="chat-input" class="w-full flex-grow p-3 rounded-md text-gray-800 focus:ring-2 focus:ring-[#FFA600] focus:outline-none" placeholder="Type or click the mic to speak...">
                            <div class="w-full sm:w-auto flex space-x-2">
                                <button id="mic-button" class="voice-button hidden">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                                </button>
                                <button id="send-button" class="w-full sm:w-auto flex-grow bg-[#FFA600] hover:bg-[#FF764A] text-white font-bold py-3 px-4 rounded-md transition-colors duration-300">Send</button>
                            </div>
                        </div>
                        <div id="chat-controls" class="mt-4 flex justify-between items-center text-sm gap-4">
                            <div class="flex items-center space-x-2">
                                <button id="clear-chat-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300">Clear Chat</button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="tts-toggle-button" class="voice-button">
                                    <svg id="speaker-on-icon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                                    <svg id="speaker-off-icon" class="w-6 h-6 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- The Supabase client library for interacting with your backend -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CONSTANTS & CONFIG ---
            const INITIAL_COACH_MESSAGE = "Hello! I'm here to offer a confidential space for our conversation. To begin, what feels most important for you to focus on today?";
            
            // Initialize the Supabase client.
            // These keys are safe to be public. The real security is in your Edge Function and database policies.
            const SUPABASE_URL = 'https://cthplmtrawzqtgdliebl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aHBsbXRyYXd6cXRnZGxpZWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NzI3NzUsImV4cCI6MjA2OTU0ODc3NX0.uzUHhbWulubUn6LZkeYQZcwLh7yVp1DXsrccP-6WPqA';
            const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- STATE MANAGEMENT ---
            let chatHistory = [];
            let conversationState = 'AWAITING_CHALLENGE'; // AWAITING_CHALLENGE, AWAITING_CONTEXT, AWAITING_PATH_CHOICE, IN_COACHING
            let userContext = null;
            let userChallenge = null;
            let isTtsEnabled = true;
            let recognition;

            // --- UI ELEMENTS ---
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const clearChatButton = document.getElementById('clear-chat-button');
            const micButton = document.getElementById('mic-button');
            const ttsToggleButton = document.getElementById('tts-toggle-button');
            const speakerOnIcon = document.getElementById('speaker-on-icon');
            const speakerOffIcon = document.getElementById('speaker-off-icon');

            // --- SPEECH API SETUP ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                micButton.classList.remove('hidden');
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0])
                        .map(result => result.transcript)
                        .join('');
                    chatInput.value = transcript;
                };

                recognition.onend = () => {
                    micButton.classList.remove('listening');
                    if (chatInput.value.trim()) {
                        handleSend();
                    }
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error", event.error);
                    micButton.classList.remove('listening');
                };

                micButton.addEventListener('click', () => {
                    if (micButton.classList.contains('listening')) {
                        recognition.stop();
                    } else {
                        recognition.start();
                        micButton.classList.add('listening');
                    }
                });
            }

            ttsToggleButton.addEventListener('click', () => {
                isTtsEnabled = !isTtsEnabled;
                speakerOnIcon.classList.toggle('hidden', !isTtsEnabled);
                speakerOffIcon.classList.toggle('hidden', isTtsEnabled);
                if (!isTtsEnabled) {
                    window.speechSynthesis.cancel();
                }
            });

            // --- CHATBOT LOGIC ---
            const addMessage = (sender, message, isHtml = false) => {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-md rounded-lg p-3 ${sender === 'user' ? 'bg-[#003F5C] text-white' : 'bg-white text-gray-800 shadow-sm'}`;
                
                let textToSpeak = message;
                if (isHtml) {
                    messageBubble.innerHTML = message;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = message;
                    textToSpeak = tempDiv.textContent || tempDiv.innerText || "";
                } else {
                    const messageText = document.createElement('p');
                    messageText.innerHTML = message.replace(/\n/g, '<br>');
                    messageBubble.appendChild(messageText);
                }
                
                messageWrapper.appendChild(messageBubble);
                chatWindow.appendChild(messageWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;

                if (sender === 'bot' && isTtsEnabled && textToSpeak.trim().length > 0) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                }
            };

            const showChatSpinner = () => {
                if (document.getElementById('chat-spinner-wrapper')) return;
                const spinnerWrapper = document.createElement('div');
                spinnerWrapper.id = 'chat-spinner-wrapper';
                spinnerWrapper.className = 'w-full flex justify-start chat-spinner';
                const bubble = document.createElement('div');
                bubble.className = 'max-w-md rounded-lg p-3 bg-white text-gray-800 shadow-sm flex items-center';
                const spinnerDiv = document.createElement('div');
                spinnerDiv.className = 'spinner';
                bubble.appendChild(spinnerDiv);
                spinnerWrapper.appendChild(bubble);
                chatWindow.appendChild(spinnerWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };

            const hideChatSpinner = () => {
                const spinnerWrapper = document.getElementById('chat-spinner-wrapper');
                if (spinnerWrapper) spinnerWrapper.remove();
            };

            const resetChat = () => {
                chatHistory = [];
                conversationState = 'AWAITING_CHALLENGE';
                userContext = null;
                userChallenge = null;
                chatWindow.innerHTML = '';
                window.speechSynthesis.cancel();
                addMessage('bot', INITIAL_COACH_MESSAGE);
            };

            // *** THIS IS THE NEW, SECURE FUNCTION ***
            // It calls your Supabase Edge Function instead of Google's API.
            const getBotResponse = async (userText, coachingPath = null) => {
                // The system prompt is now handled securely on the server.
                // We only need to manage the ongoing conversation history here.
                let userMessage = userText;
                if (coachingPath) {
                    userMessage = `The user's situation relates to ${userContext}. Their challenge is: "${userChallenge}". They have chosen the path of "${coachingPath}". Please begin the coaching process according to the instructions for that path in your system prompt.`;
                }

                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

                try {
                    // This securely calls your 'coaching-proxy' function on Supabase.
                    const { data, error } = await supabase.functions.invoke('coaching-proxy', {
                        body: { chatHistory: chatHistory },
                    });

                    if (error) throw error;

                    const botResponse = data.botResponse;
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                    hideChatSpinner();
                    addMessage('bot', botResponse);

                } catch (error) {
                    console.error("Supabase function call failed:", error);
                    hideChatSpinner();
                    addMessage('bot', 'Sorry, something went wrong. Please check the console and try again later.');
                }
            };

            const handlePathSelection = (path) => {
                const buttonContainer = document.getElementById('path-choice-container');
                if (buttonContainer) {
                    buttonContainer.remove();
                }
                
                addMessage('user', `I'll take the "${path}" path.`);
                conversationState = 'IN_COACHING';
                showChatSpinner();
                getBotResponse(null, path);
            };

            const handleSend = async () => {
                window.speechSynthesis.cancel();
                const userText = chatInput.value.trim();
                if (!userText) return;

                addMessage('user', userText);
                chatInput.value = '';
                
                if (conversationState === 'AWAITING_CHALLENGE') {
                    userChallenge = userText;
                    chatHistory.push({ role: "user", parts: [{ text: userText }] });
                    addMessage('bot', "Thank you for sharing. To help me provide the most relevant support, could you tell me a bit more about the context? For example, is this situation related to <strong>Sales</strong>, <strong>Project Management</strong>, or <strong>IT Consulting</strong>?");
                    conversationState = 'AWAITING_CONTEXT';
                } else if (conversationState === 'AWAITING_CONTEXT') {
                    userContext = userText;
                    chatHistory.push({ role: "user", parts: [{ text: `The situation is related to ${userText}.` }] });
                    
                    const summary = userChallenge.length > 80 ? userChallenge.substring(0, 80) + '...' : userChallenge;
                    const choiceHtml = `
                        <p>Thank you. It sounds like you're dealing with: "${summary}". I can help in a couple of ways.</p>
                        <p class="mt-2">Would you prefer some <strong>Quick Guidance</strong>, where I suggest a relevant framework and some key questions to think about, or would you prefer more in-depth, <strong>Situation-Specific Coaching</strong> where we can explore this together step-by-step?</p>
                        <div id="path-choice-container" class="mt-2">
                            <button class="chat-button" onclick="handlePathSelection('Quick Guidance')">Quick Guidance</button>
                            <button class="chat-button" onclick="handlePathSelection('Situation-Specific Coaching')">Situation-Specific Coaching</button>
                        </div>
                    `;
                    addMessage('bot', choiceHtml, true);
                    conversationState = 'AWAITING_PATH_CHOICE';
                } else if (conversationState === 'IN_COACHING') {
                    sendButton.disabled = true;
                    showChatSpinner();
                    await getBotResponse(userText);
                    sendButton.disabled = false;
                    chatInput.focus();
                }
            };
            
            // --- EVENT LISTENERS ---
            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') handleSend(); });
            clearChatButton.addEventListener('click', resetChat);

            window.handlePathSelection = handlePathSelection;

            // --- INITIALIZATION ---
            resetChat();
        });
    </script>
</body>
</html>
